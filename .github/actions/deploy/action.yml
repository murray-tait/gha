name: Terraform Apply
description: "Terraform Apply"
inputs:
  deployment_environment:
    required: true
    type: string
  checkout-ref:
    required: true
    type: string
  target:
    required: false
    type: string
    default: ""
  github-token:
    required: true
    type: string
  package-lambdas:
    required: false
    type: boolean
    default: false
  terraform-version:
    required: false
    type: string
    default: 1.13.4
  deployment-discord-webhook:
    required: false
    type: string
  failure_discord_webhook:
    required: false
    type: string
runs:
  using: "composite"
  steps:
    - if: inputs.deployment-discord-webhook != ''
      name: Discord start notice
      uses: tsickert/discord-webhook@v7.0.0
      with:
        webhook-url: ${{ inputs.deployment-discord-webhook }}
        username: Github
        content: "[Github Action](<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>) deployment of the repository **${{ github.repository }}** at tag **${{ inputs.checkout-ref }}** to environment **${{ inputs.deployment_environment }}** started"
    - name: Git checkout
      id: git-checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.checkout-ref }}
        fetch-depth: 0

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      id: setup-terraform
      with:
        terraform_wrapper: false
        terraform_version: ${{ inputs.terraform-version }}

    - name: Terraform Init
      id: init
      shell: bash
      run: terraform -chdir=./terraform init

    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: tfplan
        path: terraform
      continue-on-error: false

    - name: Terraform Apply
      id: terraform-apply
      shell: bash
      run: |
        if [ -n "${{ inputs.target }}" ]; then
          terraform -chdir=./terraform apply -target=${{ inputs.target }} -no-color -auto-approve -input=false tfplan | tee apply.txt
        else
          terraform -chdir=./terraform apply -no-color -auto-approve -input=false tfplan | tee apply.txt
        fi
        TERRAFORM_OUTPUT=$(cat apply.txt)
        delimiter="$(openssl rand -hex 8)"
        echo "output<<${delimiter}" >> $GITHUB_OUTPUT
        echo "## Terraform Deploy Output for ${{ inputs.deployment_environment }}" >> $GITHUB_OUTPUT
        echo "<details><summary>Click to expand</summary>" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo '```terraform' >> $GITHUB_OUTPUT
        echo "$TERRAFORM_OUTPUT" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "</details>" >> $GITHUB_OUTPUT
        echo "${delimiter}" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Publish Terraform Plan to Task Summary
      shell: bash
      env:
        APPLY_OUTPUT: ${{ steps.terraform-apply.outputs.output }}
      run: |
        echo "$APPLY_OUTPUT" >> $GITHUB_STEP_SUMMARY

    - name: Delete tag
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      with:
        script: |
          github.rest.git.deleteRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'tags/deployment/main'
          })
      continue-on-error: false

    - name: Create tag
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      with:
        script: |
          github.rest.git.createRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'refs/tags/deployment/main',
            sha: context.sha
          })
      continue-on-error: false

    - if: inputs.deployment-discord-webhook != ''
      name: Discord finish notice
      uses: tsickert/discord-webhook@v7.0.0
      with:
        webhook-url: ${{ inputs.deployment-discord-webhook }}
        username: Github
        content: "[Github Action](<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>) deployment of the repository **${{ github.repository }}** at tag **${{ inputs.checkout-ref }}** to environment**${{ inputs.deployment_environment }}** finished with **${{ job.status}}**"